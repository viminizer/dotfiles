#!/bin/bash

PLUGIN_DIR="$CONFIG_DIR/plugins"

# ===== Tokyo Night Color Palette =====
export BAR_COLOR=0xf01a1b26
export ITEM_BG_COLOR=0xff292e42
export ITEM_BG_FOCUSED=0xff3d59a1
export ACCENT_COLOR=0xff7aa2f7
export FG_COLOR=0xffc0caf5
export FG_MUTED=0xff565f89
export GREEN=0xff9ece6a
export RED=0xfff7768e
export YELLOW=0xffe0af68
export CYAN=0xff7dcfff
export MAGENTA=0xffbb9af7
export ORANGE=0xffff9e64

##### Bar Appearance #####
sketchybar --bar \
  position=top \
  height=28 \
  blur_radius=4 \
  color=$BAR_COLOR \
  margin=4 \
  corner_radius=6 \
  y_offset=4 \
  padding_left=2 \
  padding_right=2 \
  border_color=$ORANGE \
  border_width=1

##### Changing Defaults #####
default=(
  padding_left=3
  padding_right=3
  icon.font="SF Pro:Bold:12.0"
  label.font="SF Pro:Semibold:12.0"
  icon.color=$FG_COLOR
  label.color=$FG_COLOR
  icon.padding_left=6
  icon.padding_right=3
  label.padding_left=3
  label.padding_right=6
  background.color=$ITEM_BG_COLOR
  background.corner_radius=4
  background.height=20
  background.drawing=off
)
sketchybar --default "${default[@]}"

##### Aerospace Workspaces #####
sketchybar --add event aerospace_workspace_change
sketchybar --add event aerospace_monitor_change

for sid in $(aerospace list-workspaces --all); do
  sketchybar --add item space.$sid left \
    --subscribe space.$sid aerospace_workspace_change \
    --set space.$sid \
    display="$(
      v=$(aerospace list-windows --workspace "$sid" --format "%{monitor-appkit-nsscreen-screens-id}" | cut -c1)
      echo "${v:-1}"
    )" \
    drawing=off \
    background.color=$ITEM_BG_COLOR \
    background.corner_radius=4 \
    background.drawing=on \
    background.height=18 \
    icon="$sid" \
    icon.font="SF Pro:Bold:11.0" \
    icon.color=$FG_COLOR \
    icon.padding_left=8 \
    icon.padding_right=2 \
    label.font="sketchybar-app-font:Regular:13.0" \
    label.padding_right=14 \
    label.padding_left=2 \
    label.color=$FG_COLOR \
    click_script="aerospace workspace $sid" \
    script="$CONFIG_DIR/plugins/aerospace.sh $sid"
done

# Load Icons on startup
for mid in $(aerospace list-monitors | cut -c1); do
  for sid in $(aerospace list-workspaces --monitor $mid --empty no); do
    apps=$(aerospace list-windows --workspace "$sid" | awk -F'|' '{gsub(/^ *| *$/, "", $2); print $2}')
    sketchybar --set space.$sid drawing=on
    icon_strip=" "
    if [ "${apps}" != "" ]; then
      while read -r app; do
        icon_strip+=" $($CONFIG_DIR/plugins/icon_map_fn.sh "$app")"
      done <<<"${apps}"
    else
      icon_strip=""
    fi
    sketchybar --set space.$sid label="$icon_strip"
  done
done

# Always show the focused workspace at startup
FOCUSED="$(aerospace list-workspaces --focused)"
sketchybar --set space.$FOCUSED drawing=on

# Trigger initial workspace change event to highlight focused workspace
sketchybar --trigger aerospace_workspace_change FOCUSED_WORKSPACE="$FOCUSED"

# Invisible separator (handles workspace window updates)
sketchybar --add item space_separator left \
  --set space_separator \
  icon.drawing=off \
  label.drawing=off \
  background.drawing=off \
  padding_left=6 \
  padding_right=0 \
  script="$PLUGIN_DIR/space_windows.sh" \
  --subscribe space_separator aerospace_workspace_change front_app_switched space_windows_change aerospace_monitor_change

# Front app
sketchybar --add item front_app left \
  --set front_app \
  background.drawing=on \
  background.color=$ORANGE \
  background.height=20 \
  icon.font="sketchybar-app-font:Regular:12.0" \
  icon.color=0xff1a1b26 \
  icon.padding_left=8 \
  icon.padding_right=2 \
  label.font="SF Pro:Bold:11.0" \
  label.color=0xff1a1b26 \
  label.padding_left=2 \
  label.padding_right=8 \
  script="$PLUGIN_DIR/front_app.sh" \
  --subscribe front_app front_app_switched

##### Right Items #####

# Clock
sketchybar --add item clock right \
  --set clock \
  background.drawing=on \
  background.height=18 \
  icon=󰃰 \
  icon.color=$CYAN \
  icon.font="Hack Nerd Font:Bold:14.0" \
  update_freq=10 \
  script="$PLUGIN_DIR/clock.sh"

# Volume
sketchybar --add item volume right \
  --set volume \
  background.drawing=on \
  background.height=18 \
  icon.color=$MAGENTA \
  icon.font="Hack Nerd Font:Bold:14.0" \
  script="$PLUGIN_DIR/volume.sh" \
  --subscribe volume volume_change

# Battery
sketchybar --add item battery right \
  --set battery \
  background.drawing=on \
  background.height=18 \
  icon.color=$GREEN \
  icon.font="Hack Nerd Font:Bold:14.0" \
  update_freq=120 \
  script="$PLUGIN_DIR/battery.sh" \
  --subscribe battery system_woke power_source_change

# CPU usage
sketchybar --add item cpu right \
  --set cpu \
  background.drawing=on \
  background.height=18 \
  icon=󰻠 \
  icon.color=$YELLOW \
  icon.font="Hack Nerd Font:Bold:14.0" \
  update_freq=3 \
  script="$PLUGIN_DIR/cpu.sh"

##### Force all scripts to run the first time #####
sketchybar --update
