# ══════════════════════════════════════════════════════════════════════════════
# Terminal & General Settings
# ══════════════════════════════════════════════════════════════════════════════
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -g mouse on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g set-clipboard on
set -g history-limit 50000
set -g display-time 4000
set -g status-interval 5
set -g focus-events on
set -sg escape-time 0
set -g default-command "$SHELL -l"

# ══════════════════════════════════════════════════════════════════════════════
# Key Bindings (Preserved)
# ══════════════════════════════════════════════════════════════════════════════
set -g prefix C-f
unbind C-b
unbind C-a
bind-key C-a send-prefix

unbind %
bind | split-window -h -c "#{pane_current_path}"

unbind 'c'
bind-key c new-window -c "#{pane_current_path}"

unbind '"'
bind - split-window -v -c "#{pane_current_path}"

unbind r
bind r source-file ~/.config/tmux/tmux.conf

bind -r j resize-pane -D 5
bind -r k resize-pane -U 5
bind -r l resize-pane -R 5
bind -r h resize-pane -L 5
bind -r m resize-pane -Z

bind-key -n C-Enter send-keys "<C-CR>"

set-option -g update-environment 'PWD'

bind n next
unbind p
bind p previous-window

set-window-option -g mode-keys vi
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection
unbind -T copy-mode-vi MouseDragEnd1Pane

# ══════════════════════════════════════════════════════════════════════════════
# Status Bar Configuration - Purple Custom (matches kitty theme)
# ══════════════════════════════════════════════════════════════════════════════
set -g status-position top
set -g status on
set -g status-justify left
set -g status-style "bg=#050014,fg=#a1a1aa"

# Left side - Session name
set -g status-left-length 50
set -g status-left "#[fg=#8b5cf6,bold]◆ #S #[default]│ "

# Right side - Git branch, system stats, date and time
set -g status-right-length 300
set -g status-right "\
#[fg=#f472b6] #(cd #{pane_current_path}; git branch --show-current 2>/dev/null) \
#[fg=#6b7280]│ #[fg=#38bdf8]  #(top -l 1 -n 0 | grep 'CPU usage' | awk '{print $3}') \
#[fg=#6b7280]│ #[fg=#f97316]  #(uptime | sed 's/.*up //' | sed 's/,.*//' | xargs) \
#[fg=#6b7280]│ #[fg=#38bdf8]  #(docker ps -q 2>/dev/null | wc -l | tr -d ' ') \
#[fg=#6b7280]│ #[fg=#4ade80]  #(pmset -g batt | grep -Eo '[0-9]+%%' | head -1) \
#[fg=#6b7280]│ #[fg=#fbbf24]%a %d │ %H:%M"

# Window status
set -g window-status-format "#[fg=#a78bfa] #I #W "
set -g window-status-current-format "#[fg=#facc15,bold] ▶ #I #W "
set -g window-status-separator "#[fg=#fde047]|#[default]"

# ══════════════════════════════════════════════════════════════════════════════
# Pane Styling
# ══════════════════════════════════════════════════════════════════════════════
set -g pane-border-style "fg=#C9971A"
set -g pane-active-border-style "fg=#C9971A"
set -g display-panes-colour "#2e1065"
set -g display-panes-active-colour "#8b5cf6"

# ══════════════════════════════════════════════════════════════════════════════
# Message & Mode Styling
# ══════════════════════════════════════════════════════════════════════════════
set -g message-style "fg=#e4e4e7,bg=#2e1065"
set -g message-command-style "fg=#e4e4e7,bg=#2e1065"
set -g mode-style "fg=#050014,bg=#a78bfa,bold"

# ══════════════════════════════════════════════════════════════════════════════
# Copy Mode Styling
# ══════════════════════════════════════════════════════════════════════════════
set -g copy-mode-match-style "fg=#050014,bg=#c084fc"
set -g copy-mode-current-match-style "fg=#050014,bg=#d8b4fe,bold"

# ══════════════════════════════════════════════════════════════════════════════
# Plugins
# ══════════════════════════════════════════════════════════════════════════════
# How to install plugins:
#   1. Add plugin with: set -g @plugin 'github-user/plugin-name'
#   2. Press: prefix + I (capital i) to install
#   4. Press: prefix + U to update plugins
#   4. Press: prefix + alt + u to uninstall removed plugins
# ══════════════════════════════════════════════════════════════════════════════

# Plugin manager (required)
set -g @plugin 'tmux-plugins/tpm'

# vim-tmux-navigator: Seamless navigation between tmux panes and vim splits
# Usage: Ctrl+h/j/k/l to move left/down/up/right across tmux and vim
# Note: Requires matching plugin in vim/neovim
set -g @plugin 'christoomey/vim-tmux-navigator'

# tmux-resurrect: Save and restore tmux sessions
# Usage:
#   prefix + Ctrl-s  - Save session
#   prefix + Ctrl-r  - Restore session
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @resurrect-capture-pane-contents 'on'

# tmux-continuum: Auto-save sessions every 15 min, auto-restore on tmux start
# Usage: Automatic, no keys needed
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'

# tmux-yank: Copy to system clipboard
# Usage (in copy mode):
#   y        - Copy selection to clipboard
#   Y        - Copy selection and paste immediately
#   prefix + y - Copy current command line to clipboard
#   prefix + Y - Copy current working directory to clipboard
set -g @plugin 'tmux-plugins/tmux-yank'

# tmux-open: Open files and URLs from copy mode
# Usage (in copy mode, highlight text first):
#   o        - Open file/URL (xdg-open / open)
#   Ctrl-o   - Open file in $EDITOR
#   Shift-s  - Search highlighted text in Google
set -g @plugin 'tmux-plugins/tmux-open'

# ══════════════════════════════════════════════════════════════════════════════
# Popup Bindings
# ══════════════════════════════════════════════════════════════════════════════
bind ? display-popup -w 80% -h 80% -E "grep -E '^bind|^set -g @plugin' ~/.config/tmux/tmux.conf | fzf --reverse --header='Tmux Keybindings'"
bind g display-popup -d "#{pane_current_path}" -w 80% -h 80% -E "lazygit"
bind o display-popup -E "grep -E '^Host ' ~/.ssh/config 2>/dev/null | awk '{print \$2}' | grep -v '*' | fzf --reverse --header='SSH Connect' | xargs -I {} tmux new-window 'ssh {}'"
bind C-e display-popup -w 60% -h 60% -E "nvim ~/notes/scratch.md"
bind i display-popup -d "#{pane_current_path}" -w 75% -h 75% -E "zsh"
bind d display-popup -w 90% -h 90% -E "lazydocker"
unbind x
bind x display-popup -d "#{pane_current_path}" -w 70% -h 70% -E "~/.config/tmux/scripts/cmd-runner.sh"

# ══════════════════════════════════════════════════════════════════════════════
# Window Management (prefix + w, then ...)
# ══════════════════════════════════════════════════════════════════════════════
bind w switch-client -T window_table
bind -T window_table k confirm-before -p "kill window #W? (y/n)" kill-window
bind -T window_table r command-prompt -I "#W" "rename-window '%%'"
bind -T window_table n new-window -c "#{pane_current_path}"
bind -T window_table f display-popup -w 60% -h 60% -E "tmux list-windows -a -F '#{session_name}:#{window_index} #{window_name}' | fzf --reverse --header='Find Window' --border=rounded --margin=1,2 --padding=1 | cut -d' ' -f1 | xargs tmux switch-client -t"

# ══════════════════════════════════════════════════════════════════════════════
# Session Management (prefix + s, then ...)
# ══════════════════════════════════════════════════════════════════════════════
bind s switch-client -T session_table
bind -T session_table s display-popup -w 50% -h 50% -E "tmux list-sessions -F '#{session_name}' | fzf --reverse --header='Switch Session' --border=rounded --margin=1,2 --padding=1 --preview='tmux list-windows -t {}' --preview-window=down:3:wrap | xargs tmux switch-client -t"
bind -T session_table l choose-tree -s
bind -T session_table n command-prompt -p "New session name:" "new-session -d -s '%%' && switch-client -t '%%'"
bind -T session_table k display-popup -w 50% -h 50% -E "tmux list-sessions -F '#{session_name}' | grep -v \"^$(tmux display-message -p '#S')\$\" | fzf --reverse --header='Kill Session' --border=rounded --margin=1,2 --padding=1 --preview='tmux list-windows -t {}' --preview-window=down:3:wrap | xargs tmux kill-session -t"
bind -T session_table r command-prompt -I "#S" "rename-session '%%'"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'

